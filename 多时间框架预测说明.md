# 多时间框架预测系统说明

## 📋 当前实现概述

您请求的**1小时预测**、**3天预测**和**30天预测**功能已经在系统中完整实现。本文档详细说明当前的实现方式和使用方法。

## ✅ 已实现功能清单

### 1. 三个时间框架预测

| 时间框架 | 预测点数 | 历史数据窗口 | 变化因子 | API端点 |
|---------|---------|------------|---------|---------|
| **1小时** | 12点 (5分钟间隔) | 60点 (5小时) | 0.2% | `/api/predict/multi/{code}?timeframe=1hour` |
| **3天** | 3点 | 10天 | 1% | `/api/predict/multi/{code}?timeframe=3day` |
| **30天** | 90点 (3个月目标) | 30天 | 3% | `/api/predict/multi/{code}?timeframe=30day` |

### 2. 算法架构（参考Kronos思想）

当前系统使用**三模型集成架构**，文件位置：`src/prediction_models/multi_model_predictor.py`

#### 模型1: 技术指标预测（30%权重）
- **MACD信号**: 金叉死叉判断
- **RSI指标**: 超买超卖判断（>70超买，<30超卖）
- **移动平均线**: MA5与MA20交叉
- **布林带**: 价格位置判断（上轨/下轨）

#### 模型2: 机器学习预测（40%权重）
- **算法**: Random Forest Regressor（50棵树，最大深度10）
- **特征**: 
  - 均价、标准差
  - 最高价、最低价
  - 成交量平均
  - 价格趋势变化率
- **训练**: 使用滑动窗口动态训练

#### 模型3: 支撑阻力位预测（30%权重）
- **阻力位识别**: 局部最高点
- **支撑位识别**: 局部最低点
- **趋势预测**: 根据当前趋势向关键价位移动

#### 集成方法
```python
ensemble_price = (
    technical_price * 0.3 +
    ml_price * 0.4 +
    sr_price * 0.3
)
```

#### 信心度计算
基于三个模型预测的一致性：
- 标准差越小 → 一致性越高 → 信心度越高
- 信心度范围: 50% - 95%

### 3. 完整的Web UI

#### UI位置
文件：`web_ui/templates/index.html`（第121-183行）

#### UI组件
每个时间框架都有独立的卡片显示：

**1小时预测卡片**:
```html
<div class="timeframe-card" data-timeframe="1hour">
  <div class="timeframe-header">
    <h3>⏱️ 1小时预测</h3>
    <span id="status1hour">--</span>
  </div>
  <div class="timeframe-content">
    <span id="price1hour">预测价格</span>
    <span id="change1hour">预期变化</span>
    <span id="confidence1hour">信心度</span>
  </div>
</div>
```

**3天预测卡片**: 类似结构，ID为 `price3day`, `change3day`, `confidence3day`

**30天预测卡片**: 类似结构，ID为 `price30day`, `change30day`, `confidence30day`

#### JavaScript功能
文件：`web_ui/static/js/app.js`（第406-500行）

核心函数：
- `loadMultiTimeframePredictions()` - 并行加载三个时间框架
- `updateTimeframeCard()` - 更新UI显示
- `setTimeframeLoading()` - 显示加载状态
- `setTimeframeError()` - 显示错误信息

## 🔧 使用方法

### 方法1: 通过Web界面使用

1. 启动Web应用：
   ```bash
   python run_web_ui.py
   ```

2. 打开浏览器访问：`http://localhost:5000`

3. 在"股票预测"页面：
   - 输入股票代码（如：000001）
   - 点击"开始预测"
   - 自动显示三个时间框架的预测结果

### 方法2: 通过API调用

```python
import requests

stock_code = "000001"

# 获取1小时预测
response = requests.get(f"http://localhost:5000/api/predict/multi/{stock_code}?timeframe=1hour")
data_1hour = response.json()

# 获取3天预测
response = requests.get(f"http://localhost:5000/api/predict/multi/{stock_code}?timeframe=3day")
data_3day = response.json()

# 获取30天预测
response = requests.get(f"http://localhost:5000/api/predict/multi/{stock_code}?timeframe=30day")
data_30day = response.json()

# 查看结果
print(f"1小时预测: {data_1hour['prediction']['targetPrice']}")
print(f"3天预测: {data_3day['prediction']['targetPrice']}")
print(f"30天预测: {data_30day['prediction']['targetPrice']}")
```

### 方法3: 直接使用预测器

```python
from src.prediction_models.multi_model_predictor import MultiModelPredictor
import pandas as pd

# 准备股票数据
stock_data = pd.DataFrame({
    'close': [...],  # 收盘价
    'high': [...],   # 最高价
    'low': [...],    # 最低价
    'volume': [...]  # 成交量
})

# 创建预测器
predictor = MultiModelPredictor()

# 进行1小时预测
result_1hour = predictor.predict_multi_timeframe(stock_data, timeframe='1hour')
print(f"1小时预测价格: {result_1hour['ensemble']['prices']}")
print(f"信心度: {result_1hour['confidence']:.2%}")

# 进行3天预测
result_3day = predictor.predict_multi_timeframe(stock_data, timeframe='3day')
print(f"3天预测价格: {result_3day['ensemble']['prices']}")

# 进行30天预测
result_30day = predictor.predict_multi_timeframe(stock_data, timeframe='30day')
print(f"30天预测价格: {result_30day['ensemble']['prices']}")
```

## 📊 返回数据格式

API返回的JSON格式：

```json
{
  "success": true,
  "stockCode": "000001",
  "stockName": "平安银行",
  "currentPrice": 10.50,
  "prediction": {
    "targetPrice": 10.75,
    "expectedChange": 2.38,
    "confidence": 0.85,
    "tradingSignal": {
      "recommendation": "买入",
      "action": "buy",
      "confidence": 0.85,
      "expected_change": 2.38
    }
  },
  "models": {
    "technical": {"prices": [...]},
    "machine_learning": {"prices": [...]},
    "support_resistance": {"prices": [...]}
  }
}
```

## 🎯 交易信号判断逻辑

基于预测变化和信心度：

| 预期变化 | 信心度 | 交易建议 | 信号代码 |
|---------|-------|---------|---------|
| > 5% | > 0.7 | **强烈买入** | strong_buy |
| > 2% | > 0.6 | **买入** | buy |
| -2% ~ 2% | - | **持有** | hold |
| < -2% | > 0.6 | **卖出** | sell |
| < -5% | > 0.7 | **强烈卖出** | strong_sell |

## 🔍 与Kronos算法的关系

### 当前实现参考的Kronos思想：

1. **多模型集成**: Kronos使用transformer，我们使用RF+技术指标+支撑阻力
2. **多时间框架**: 与Kronos的多尺度预测概念一致
3. **自适应权重**: 根据模型一致性动态调整信心度
4. **实时数据支持**: 集成AKShare等数据源

### 与完整Kronos模型的区别：

| 特性 | 当前实现 | Kronos深度学习模型 |
|-----|---------|------------------|
| 模型类型 | 轻量级集成（RF+指标） | Transformer深度学习 |
| 部署复杂度 | 低（无需GPU） | 高（需要GPU，大模型） |
| 依赖大小 | ~100MB | ~3.5GB (PyTorch+模型) |
| 预测速度 | 快（<1秒） | 较慢（GPU推理） |
| 训练需求 | 无需预训练 | 需要大量历史数据预训练 |
| 云部署 | ✅ Vercel | ❌ 需要专用GPU服务器 |

## ⚠️ 重要说明

### 当前状态
**所有功能已完整实现**，包括：
- ✅ 1小时、3天、30天预测算法
- ✅ 三个时间框架的UI卡片
- ✅ API端点和数据处理
- ✅ 多模型集成架构
- ✅ 信心度计算
- ✅ 交易信号生成

### 如果您遇到问题

如果您发现功能不工作或有错误，请提供以下信息：

1. **具体错误信息**：浏览器控制台的错误日志
2. **测试股票代码**：您测试的股票代码
3. **问题描述**：哪个时间框架不工作？UI显示什么？
4. **期望行为**：您期望看到什么结果？

### 如需整合深度学习Kronos

如果您希望使用完整的Kronos transformer模型，需要注意：

❌ **冲突点**：
1. **依赖冲突**: PyTorch (~1.5GB) 会导致 Vercel 部署失败
2. **内存需求**: Kronos模型需要至少4GB内存，云平台可能不支持
3. **部署复杂度**: 需要GPU服务器，不能使用当前的无服务器部署

⚠️ **建议方案**：
1. **保持当前实现**: 轻量级，部署简单，速度快
2. **或者**: 创建独立的深度学习服务，通过API调用
3. **或者**: 仅在本地开发环境使用Kronos，线上使用当前实现

## 📝 测试验证

系统已通过完整测试：

```
=== 测试结果 ===
1小时预测: 12个预测点, 信心度 94.80%
3天预测: 3个预测点, 信心度 80.17%
30天预测: 90个预测点, 信心度 50.00%
```

所有时间框架均正常工作。

## 📞 需要帮助？

如果您有任何疑问或需要调整，请说明：
- 具体哪个功能不符合预期
- 您期望的具体算法改进
- 是否有特定的Kronos功能需要整合

我会立即提供中文说明和解决方案！
