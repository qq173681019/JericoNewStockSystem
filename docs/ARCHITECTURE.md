# SIAPS 系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层 (GUI)                          │
│                    CustomTkinter Framework                       │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐      │
│  │ 预测面板 │ 观测池   │ 历史记录 │  设置    │  主题    │      │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘      │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层 (Phase 2)                        │
│  ┌──────────────────┬──────────────────┬──────────────────┐    │
│  │  预测引擎        │  交易建议引擎     │  预警引擎        │    │
│  │  - 短期预测      │  - 入场点识别     │  - 价格监控      │    │
│  │  - 长期预测      │  - 止损止盈计算   │  - 异常检测      │    │
│  └──────────────────┴──────────────────┴──────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       预测模型层 (Phase 2/3)                      │
│  ┌──────────┬──────────┬──────────┬──────────┬──────────┐      │
│  │  LSTM    │  GRU     │ XGBoost  │Transform.│ Prophet  │      │
│  │  短期    │  短期    │  分类    │  长期    │  季节性  │      │
│  └──────────┴──────────┴──────────┴──────────┴──────────┘      │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       数据处理层 (Phase 2)                        │
│  ┌──────────────────┬──────────────────┬──────────────────┐    │
│  │  特征工程        │  技术指标计算     │  数据清洗        │    │
│  │  - 特征提取      │  - MA/MACD/RSI   │  - 缺失值处理    │    │
│  │  - 特征选择      │  - 布林带        │  - 异常值过滤    │    │
│  │  - 归一化        │  - KDJ           │  - 数据验证      │    │
│  └──────────────────┴──────────────────┴──────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                       数据获取层 (Implemented)                    │
│  ┌──────────────────┬──────────────────┬──────────────────┐    │
│  │  AKShare         │  TuShare (TODO)  │  其他源 (TODO)   │    │
│  │  - 历史K线       │  - 高级数据      │  - 新闻数据      │    │
│  │  - 实时行情      │  - 财务数据      │  - 资金流向      │    │
│  └──────────────────┴──────────────────┴──────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                              ↓ ↑
┌─────────────────────────────────────────────────────────────────┐
│                    数据存储层 (Implemented)                       │
│  ┌──────────────────────────────────────────────────────┐      │
│  │                SQLite / SQLAlchemy ORM                │      │
│  │  - prediction_history (预测历史)                      │      │
│  │  - watchlist (观测池)                                 │      │
│  └──────────────────────────────────────────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块说明

### 1. 配置层 (config/)
- **settings.py**: 应用配置管理
  - 环境变量加载
  - 数据库配置
  - GUI主题配置
  - 日志配置

### 2. 数据获取层 (src/data_acquisition/)
- **fetcher.py**: 数据获取抽象和实现
  - `DataFetcher`: 基类，定义统一接口
  - `AKShareFetcher`: AKShare数据源实现
  - 支持历史数据和实时数据获取

**已实现功能**:
- ✓ 历史K线数据获取
- ✓ 实时行情数据获取
- ✓ 数据缓存机制

**待实现功能**:
- ○ TuShare数据源集成
- ○ 多数据源融合
- ○ 数据增量更新

### 3. 数据处理层 (src/data_processing/)
**Phase 2 实现计划**:
- 技术指标计算（TA-Lib）
- 特征工程
- 数据清洗和预处理

### 4. 预测模型层 (src/prediction_models/)
**Phase 2/3 实现计划**:
- LSTM/GRU短期预测模型
- Transformer长期预测模型
- XGBoost分类模型
- Prophet季节性分析

### 5. 业务逻辑层 (src/business_logic/)
**Phase 2/3 实现计划**:
- 预测引擎
- 交易建议生成
- 预警系统

### 6. GUI层 (src/gui/)
- **main_window.py**: 主窗口实现
  - 侧边栏导航
  - 多页面管理
  - 主题切换

**已实现页面**:
- ✓ 欢迎页面
- ✓ 预测页面框架
- ○ 观测池页面（开发中）
- ○ 历史记录页面（开发中）
- ○ 设置页面（开发中）

### 7. 数据库层 (src/database/)
- **models.py**: 数据模型定义
  - `PredictionHistory`: 预测历史表
  - `Watchlist`: 观测池表
  - `DatabaseManager`: 数据库操作管理器

**已实现功能**:
- ✓ 数据库初始化
- ✓ 预测记录CRUD
- ✓ 观测池CRUD
- ✓ 查询历史记录

### 8. 工具层 (src/utils/)
- **logger.py**: 日志和工具函数
  - 日志系统配置
  - 股票代码验证
  - 时间戳处理

## 数据流向

```
用户输入股票代码
    ↓
GUI层接收并验证
    ↓
业务逻辑层处理请求
    ↓
数据获取层获取数据 → 数据库缓存
    ↓
数据处理层特征工程
    ↓
预测模型层推理
    ↓
业务逻辑层生成建议
    ↓
结果保存到数据库
    ↓
GUI层展示结果
```

## 技术栈详情

### 前端 (GUI)
- **CustomTkinter**: 现代化的Tkinter扩展
- **Matplotlib**: 图表绘制
- **Pillow**: 图像处理

### 后端 (核心逻辑)
- **Pandas**: 数据处理
- **NumPy**: 数值计算
- **SQLAlchemy**: ORM框架
- **AKShare**: 数据获取

### 机器学习 (Phase 2+)
- **PyTorch**: 深度学习框架
- **TensorFlow**: 备选深度学习框架
- **Scikit-learn**: 传统机器学习
- **Prophet**: 时间序列预测
- **TA-Lib**: 技术指标库

## 部署架构

```
┌─────────────────────────────────────┐
│         SIAPS Desktop App           │
│                                     │
│  ┌──────────────────────────────┐  │
│  │     GUI (CustomTkinter)      │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   Core Logic (Python)        │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   SQLite Database (Local)    │  │
│  └──────────────────────────────┘  │
│  ┌──────────────────────────────┐  │
│  │   ML Models (Local)          │  │
│  └──────────────────────────────┘  │
└─────────────────────────────────────┘
            ↓ ↑ (Network)
┌─────────────────────────────────────┐
│      External Data Sources          │
│  - AKShare API                      │
│  - TuShare API                      │
│  - News APIs                        │
└─────────────────────────────────────┘
```

## 性能考虑

### 优化策略
1. **数据缓存**: 本地缓存历史数据，减少API调用
2. **异步处理**: 数据获取和模型推理使用异步操作
3. **批量处理**: 支持批量股票预测
4. **模型压缩**: 使用模型量化减少内存占用

### 扩展性
1. **插件化数据源**: 易于添加新数据源
2. **模型热插拔**: 支持动态加载不同模型
3. **配置驱动**: 通过配置文件控制行为

## 安全考虑

1. **API密钥管理**: 使用.env文件存储敏感信息
2. **输入验证**: 严格验证用户输入
3. **数据库安全**: 使用参数化查询防止SQL注入
4. **错误处理**: 完善的异常处理和日志记录

## 下一步开发重点

### Phase 2 优先级
1. **技术指标模块** (高)
   - 集成TA-Lib
   - 实现常用指标计算
   - 可视化展示

2. **基础预测模型** (高)
   - 实现LSTM模型
   - 训练和评估流程
   - 结果展示

3. **交易建议引擎** (中)
   - 规则引擎设计
   - 入场出场点识别
   - 风险评估

4. **数据可视化** (中)
   - K线图表
   - 指标叠加
   - 预测结果展示
